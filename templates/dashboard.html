<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Dashboard</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{
    background:#f4f6f9;
    color:#1f2937;
}
h3{
    font-weight:700;
}
.card{
    border-radius:18px;
    border:none;
}
.card-header{
    background:transparent;
    border-bottom:none;
    font-weight:600;
    font-size:15px;
}
.kpi{
    font-size:36px;
    font-weight:800;
    color:#2563eb;
}
.kpi-label{
    font-size:14px;
    color:#6b7280;
}
.table thead{
    background:#e5e7eb;
}
.badge{
    border-radius:8px;
    font-weight:500;
}
.btn-outline-primary{
    border-radius:10px;
}
.modal-content{
    border-radius:16px;
}
canvas{
    max-height:300px;
}
</style>
</head>

<body>
<div class="container-fluid px-4 py-4">

<h3 class="mb-4">üìä Dashboard de Colaboradores</h3>

<!-- ================= KPIs ================= -->
<div class="row g-4 mb-4">

<div class="col-md-3">
<div class="card shadow-sm p-3">
<div class="kpi">{{ total }}</div>
<div class="kpi-label">Total colaboradores</div>
</div>
</div>

<div class="col-md-3">
<div class="card shadow-sm p-3">
<div class="kpi">{{ colaboradores|length }}</div>
<div class="kpi-label">Registros activos</div>
</div>
</div>

<div class="col-md-3">
<div class="card shadow-sm p-3">
<div class="kpi">
{{ colaboradores | selectattr("rol_comercial") | list | length }}
</div>
<div class="kpi-label">Colaboradores comerciales</div>
</div>
</div>

</div>

<!-- ================= GR√ÅFICAS ================= -->
<div class="row g-4 mb-4">

<div class="col-lg-6">
<div class="card shadow-sm p-3">
<div class="card-header">Colaboradores por √°rea</div>
<canvas id="graficaAreas"></canvas>
</div>
</div>

<div class="col-lg-6">
<div class="card shadow-sm p-3">
<div class="card-header">Asignaci√≥n de recursos</div>
<canvas id="graficaRecursos"></canvas>
</div>
</div>

</div>

<!-- ================= TABLA ================= -->
<div class="card shadow-sm">
<div class="card-body">

<h6 class="mb-3 fw-bold">Detalle de colaboradores</h6>

<table class="table table-hover align-middle">
<thead>
<tr>
<th>Nombre</th>
<th>√Årea</th>
<th>Correo</th>
<th>Recursos</th>
<th>Programas</th>
<th>Docs</th>
</tr>
</thead>
<tbody>

{% for c in colaboradores %}
<tr>
<td>{{ c.nombre }} {{ c.apellido }}</td>
<td>{{ c.area.nombre }}</td>
<td>{{ c.correo }}</td>
<td>
{% for r in c.recursos %}
<span class="badge bg-secondary me-1">{{ r.nombre }}</span>
{% endfor %}
</td>
<td>
{% for p in c.programas %}
<span class="badge bg-info text-dark me-1">{{ p.nombre }}</span>
{% endfor %}
</td>
<td>
<button class="btn btn-sm btn-outline-primary"
data-bs-toggle="modal"
data-bs-target="#docs{{ c.id }}">
Ver
</button>
</td>
</tr>
{% endfor %}

</tbody>
</table>

</div>
</div>

<!-- ================= MODALES DOCUMENTOS ================= -->
{% for c in colaboradores %}
<div class="modal fade" id="docs{{ c.id }}" tabindex="-1">
<div class="modal-dialog modal-lg modal-dialog-centered">
<div class="modal-content">

<div class="modal-header">
<h5 class="modal-title">üìÅ Documentos ‚Äì {{ c.nombre }} {{ c.apellido }}</h5>
<button class="btn-close" data-bs-dismiss="modal"></button>
</div>

<div class="modal-body">
{% for d in c.documentos %}
<a href="/documento/{{ d.id }}" target="_blank" class="d-block mb-1">
üìÑ {{ d.nombre_archivo }}
</a>
{% else %}
<em>No hay documentos</em>
{% endfor %}
</div>

</div>
</div>
</div>
{% endfor %}

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
// ===== DATOS JINJA =====
const areas = {};
{% for c in colaboradores %}
areas["{{ c.area.nombre }}"] = (areas["{{ c.area.nombre }}"] || 0) + 1;
{% endfor %}

const recursos = {};
{% for c in colaboradores %}
    {% for r in c.recursos %}
        recursos["{{ r.nombre }}"] = (recursos["{{ r.nombre }}"] || 0) + 1;
    {% endfor %}
{% endfor %}

// ===== GR√ÅFICA √ÅREAS =====
new Chart(document.getElementById("graficaAreas"), {
    type: 'bar',
    data: {
        labels: Object.keys(areas),
        datasets: [{
            data: Object.values(areas),
            backgroundColor:'#2563eb'
        }]
    },
    options: {
        plugins:{legend:{display:false}},
        scales:{y:{beginAtZero:true}}
    }
});

// ===== GR√ÅFICA RECURSOS =====
new Chart(document.getElementById("graficaRecursos"), {
    type: 'doughnut',
    data: {
        labels: Object.keys(recursos),
        datasets: [{
            data: Object.values(recursos),
            backgroundColor:[
                '#2563eb','#16a34a','#f59e0b',
                '#ec4899','#6366f1'
            ]
        }]
    }
});
</script>

</body>
</html>
