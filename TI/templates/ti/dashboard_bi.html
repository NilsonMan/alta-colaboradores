{% extends "base.html" %}

{% block title %}Dashboard BI Profesional{% endblock %}

{% block head %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- Socket.IO -->
<script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
<!-- Dashboard CSS -->
<link rel="stylesheet" href="/static/css/dashboard.css">

<!-- Dashboard JS (defer) -->
<script src="/static/js/dashboard_bi.js" defer></script>
{% endblock %}

{% block content %}
<!-- Configuración global -->
<script>
const DASHBOARD_CONFIG = {
    AREA_COMERCIAL_ID: 2,
    CURRENT_YEAR: parseInt('{{ current_year }}'),
    AVAILABLE_YEARS: [{% for year in available_years %}{{ year }}{% if not loop.last %}, {% endif %}{% endfor %}],
    API_ENDPOINTS: {
        kpis: '/api/kpis',
        contrataciones: '/api/contrataciones',
        bajas: '/api/bajas',
        comparativa: '/api/contrataciones/comparativa',
        reclutadores: '/api/contrataciones/reclutador',
        detalle_reclutador: '/api/contrataciones/detalle-reclutador/',
        reclutadores_comercial: '/api/reclutadores/comercial',
        buscar_reclutador: '/api/buscar-reclutador'
    },
    MESES: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
            'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'],
    MESES_CORTOS: ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 
                   'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'],
    COLORS: {
        gestion: '#ff6b6b',
        comercial: '#4ecdc4',
        years: ['#36a2eb', '#ff6384', '#ff9f40', '#4bc0c0', '#9966ff', '#ffcd56']
    }
};
</script>

<div class="dashboard-container">
    <!-- HEADER -->
    <div class="dashboard-header mb-4">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="dashboard-title">
                    <i class="bi bi-bar-chart-line-fill me-2"></i>Dashboard BI - Altas y Bajas
                </h1>
                <p class="dashboard-subtitle">Análisis detallado de contrataciones y retención</p>
            </div>
            <div class="dashboard-quick-stats">
                <span class="badge badge-accent">
                    <i class="bi bi-calendar3 me-1"></i>
                    <span id="currentDate">{{ current_date }}</span>
                </span>
                <span class="badge badge-secondary">
                    <i class="bi bi-clock-history me-1"></i>
                    Última actualización: <span id="lastUpdate">--:--</span>
                </span>
            </div>
        </div>
    </div>

    <!-- FILTROS PRINCIPALES -->
    <div class="dashboard-filters card mb-4">
        <div class="card-body">
            <div class="row g-3 align-items-center">
                <div class="col-md-3">
                    <label class="form-label fw-bold"><i class="bi bi-calendar-range me-2"></i>Año</label>
                    <select id="yearSelect" class="form-select">
                        <option value="">Seleccionar año</option>
                        {% for year in available_years %}
                        <option value="{{ year }}" {% if year == current_year %}selected{% endif %}>{{ year }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="col-md-3">
                    <label class="form-label fw-bold"><i class="bi bi-calendar-month me-2"></i>Mes</label>
                    <select id="monthSelect" class="form-select">
                        <option value="">Todos los meses</option>
                        {% for mes in ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'] %}
                        <option value="{{ loop.index }}">{{ mes }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="col-md-4">
                    <label class="form-label fw-bold"><i class="bi bi-graph-up me-2"></i>Comparar Años</label>
                    <select id="compareYearSelect" class="form-select" multiple>
                        {% for year in available_years %}
                        <option value="{{ year }}" {% if year == current_year or year == current_year-1 %}selected{% endif %}>{{ year }}</option>
                        {% endfor %}
                    </select>
                    <small class="form-text">Ctrl+clic para múltiple selección</small>
                </div>
                
                <div class="col-md-2">
                    <label class="form-label fw-bold"><i class="bi bi-filter me-2"></i>Acciones</label>
                    <div class="d-flex gap-2">
                        <button id="btnRefresh" class="btn btn-primary w-100">
                            <i class="bi bi-arrow-clockwise me-2"></i>Actualizar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- KPIs PRINCIPALES -->
    <div class="row mb-4">
        <div class="col-xl-3 col-lg-6 mb-3">
            <div class="card kpi-card">
                <div class="card-body text-center">
                    <div class="kpi-icon mb-3">
                        <i class="bi bi-person-plus-fill"></i>
                    </div>
                    <h3 id="kpiTotalContrataciones" class="kpi-value skeleton">0</h3>
                    <p class="kpi-title">Total Contrataciones</p>
                    <div class="kpi-sub" id="kpiTotalSubtitle">Período seleccionado</div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-lg-6 mb-3">
            <div class="card kpi-card">
                <div class="card-body text-center">
                    <div class="kpi-icon mb-3">
                        <i class="bi bi-person-dash-fill"></i>
                    </div>
                    <h3 id="kpiBajasComercial" class="kpi-value skeleton">0</h3>
                    <p class="kpi-title">Bajas Comercial</p>
                    <div class="kpi-sub">Área ID: 5 (Reclutadores)</div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-lg-6 mb-3">
            <div class="card kpi-card">
                <div class="card-body text-center">
                    <div class="kpi-icon mb-3">
                        <i class="bi bi-person-dash-fill"></i>
                    </div>
                    <h3 id="kpiBajasGestion" class="kpi-value skeleton">0</h3>
                    <p class="kpi-title">Bajas Gestión</p>
                    <div class="kpi-sub">Área: No comercial</div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-lg-6 mb-3">
            <div class="card kpi-card">
                <div class="card-body text-center">
                    <div class="kpi-icon mb-3">
                        <i class="bi bi-graph-up-arrow"></i>
                    </div>
                    <h3 id="kpiRetencion" class="kpi-value skeleton">0%</h3>
                    <p class="kpi-title">Tasa Retención</p>
                    <div class="kpi-sub">(Activos / Total)</div>
                </div>
            </div>
        </div>
    </div>

    <!-- GRÁFICAS PRINCIPALES -->
    <div class="row mb-4">
        <!-- Gráfica Altas -->
        <div class="col-xl-8 mb-4">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="mb-0"><i class="bi bi-bar-chart-line me-2"></i>Contrataciones por Mes</h5>
                        <small class="text-muted" id="chartAltasSummary">Total: 0 | Gestión: 0 | Comercial: 0</small>
                    </div>
                    <div class="d-flex gap-2">
                        <button class="btn btn-sm btn-info" onclick="showModalDetalleComercial()">
                            <i class="bi bi-people-fill me-1"></i>Detalle Comercial
                        </button>
                        <button class="btn btn-sm btn-info" onclick="showModalDetalleReclutadores()">
                            <i class="bi bi-person-badge me-1"></i>Ver Reclutadores
                        </button>
                    </div>
                </div>
                <div class="card-body position-relative" style="height: 400px;">
                    <div class="chart-loading" id="loadingAltas">
                        <div class="text-center py-5">
                            <div class="spinner-border text-primary" role="status"></div>
                            <p class="mt-3">Cargando gráfica de contrataciones...</p>
                        </div>
                    </div>
                    <canvas id="chartAltas"></canvas>
                </div>
                <div class="card-footer">
                    <div class="chart-legend d-flex justify-content-center gap-4">
                        <div class="legend-item">
                            <span class="legend-color" style="background-color: #ff6b6b;"></span>
                            <span class="legend-label">Gestión (Total, incluye bajas)</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-color" style="background-color: #4ecdc4;"></span>
                            <span class="legend-label">Comercial (Total, incluye bajas)</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Top Reclutadores -->
        <div class="col-xl-4 mb-4">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-trophy-fill me-2"></i>Top Reclutadores</h5>
                    <button class="btn btn-sm btn-outline-primary" onclick="loadReclutadoresData()">
                        <i class="bi bi-arrow-clockwise"></i>
                    </button>
                </div>
                <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                    <div id="reclutadoresList" class="list-group">
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary" role="status"></div>
                            <p class="mt-2 text-muted">Cargando reclutadores...</p>
                        </div>
                    </div>
                </div>
                <div class="card-footer text-center">
                    <small class="text-muted">Click en un reclutador para ver detalle</small>
                </div>
            </div>
        </div>
    </div>

    <!-- GRÁFICA BAJAS Y COMPARATIVA -->
    <div class="row mb-4">
        <!-- Gráfica Bajas -->
        <div class="col-xl-6 mb-4">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="mb-0"><i class="bi bi-graph-down me-2"></i>Bajas por Mes</h5>
                        <small class="text-muted" id="chartBajasSummary">Total: 0 | Gestión: 0 | Comercial: 0</small>
                    </div>
                </div>
                <div class="card-body position-relative" style="height: 300px;">
                    <div class="chart-loading" id="loadingBajas">
                        <div class="text-center py-5">
                            <div class="spinner-border text-primary" role="status"></div>
                            <p class="mt-3">Cargando gráfica de bajas...</p>
                        </div>
                    </div>
                    <canvas id="chartBajas"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Gráfica Comparativa Años -->
        <div class="col-xl-6 mb-4">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-calendar2-range me-2"></i>Comparativa por Año</h5>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="toggleNormalized">
                        <label class="form-check-label" for="toggleNormalized">Normalizar</label>
                    </div>
                </div>
                <div class="card-body position-relative" style="height: 300px;">
                    <div class="chart-loading" id="loadingComparativa">
                        <div class="text-center py-5">
                            <div class="spinner-border text-primary" role="status"></div>
                            <p class="mt-3">Cargando comparativa...</p>
                        </div>
                    </div>
                    <canvas id="chartComparativa"></canvas>
                </div>
                <div class="card-footer">
                    <small class="text-muted">Comparativa de años seleccionados</small>
                </div>
            </div>
        </div>
    </div>

    <!-- TABLA DETALLADA -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0"><i class="bi bi-table me-2"></i>Detalle por Mes</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover" id="tableDetalleMes">
                    <thead>
                        <tr>
                            <th>Mes</th>
                            <th>Contrataciones Gestión</th>
                            <th>Contrataciones Comercial</th>
                            <th>Bajas Gestión</th>
                            <th>Bajas Comercial</th>
                            <th>Total Contrataciones</th>
                            <th>Total Bajas</th>
                            <th>Retención</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="tableDetalleBody">
                        <!-- Los datos se cargarán aquí -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modales -->
{% include 'modals/dashboard_modals.html' %}

<!-- Templates -->
{% include 'templates/dashboard_templates.html' %}
{% endblock %}